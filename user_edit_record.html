<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑记录 - 费用统计系统</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <div>
                <a href="user_dashboard.html">我的数据</a>
                <a href="user_add_record.html">录入数据</a>
            </div>
            <div class="nav-right">
                <span id="userName" style="color: white;"></span>
                <a href="user_logout.php">退出登录</a>
            </div>
        </div>

        <h2>编辑记录</h2>

        <form id="editForm" style="max-width: 600px; margin: 0 auto;">
            <input type="hidden" id="recordId" name="id">
            
            <div class="form-group">
                <label for="salesperson_name">业务员：</label>
                <input type="text" id="salesperson_name" name="salesperson_name" readonly style="background-color: #f0f0f0;">
            </div>

            <div class="form-group">
                <label for="record_date">日期：</label>
                <input type="date" id="record_date" name="record_date" required>
            </div>

            <div class="form-group">
                <label for="deposit">定金（元）：</label>
                <input type="number" id="deposit" name="deposit" step="0.01" value="0" required>
            </div>

            <div class="form-group">
                <label for="location">地址：</label>
                <input type="text" id="location" name="location">
            </div>

            <div class="form-group">
                <label for="fare">车费（元）：</label>
                <input type="number" id="fare" name="fare" step="0.01" value="0" required>
            </div>

            <div class="form-group">
                <label for="project_fee">项目费用（元）：</label>
                <input type="number" id="project_fee" name="project_fee" step="0.01" value="0" required>
            </div>

            <div class="form-group">
                <label for="overtime_fee">加钟费（元）：</label>
                <input type="number" id="overtime_fee" name="overtime_fee" step="0.01" value="0" required>
            </div>

            <div class="form-group">
                <label for="commission">应得佣金35%（自动计算）：</label>
                <input type="number" id="commission" name="commission" step="0.01" readonly style="background-color: #f0f0f0;">
            </div>

            <button type="submit" class="btn btn-primary btn-full">保存修改</button>
        </form>
        
        <div id="message" class="message" style="max-width: 600px; margin: 20px auto 0;"></div>
    </div>

    <script>
        // 加载用户信息
        fetch('user_check_session.php')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    window.location.href = 'user_login.html';
                } else {
                    document.getElementById('userName').textContent = '用户: ' + data.data.realname;
                }
            });

        // 获取URL参数
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // 加载记录数据
        var recordId = getUrlParameter('id');
        if (recordId) {
            fetch('user_get_record.php?id=' + recordId)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        var record = data.record;
                        document.getElementById('recordId').value = record.id;
                        document.getElementById('salesperson_name').value = record.salesperson_name;
                        document.getElementById('record_date').value = record.record_date;
                        document.getElementById('deposit').value = record.deposit;
                        document.getElementById('location').value = record.location;
                        document.getElementById('fare').value = record.fare;
                        document.getElementById('project_fee').value = record.project_fee;
                        document.getElementById('overtime_fee').value = record.overtime_fee;
                        document.getElementById('commission').value = record.commission;
                        // 初始计算一次佣金
                        calculateSalary();
                    } else {
                        alert(data.message);
                        window.location.href = 'user_dashboard.html';
                    }
                })
                .catch(error => {
                    console.error('Error loading record:', error);
                    alert('加载记录失败，请重试！');
                    window.location.href = 'user_dashboard.html';
                });
        }

        // 自动计算抽成和工资
        function calculateSalary() {
            var deposit = parseFloat(document.getElementById('deposit').value) || 0;
            var projectFee = parseFloat(document.getElementById('project_fee').value) || 0;
            var overtimeFee = parseFloat(document.getElementById('overtime_fee').value) || 0;
            var fare = parseFloat(document.getElementById('fare').value) || 0;
            
            var total = deposit + projectFee + overtimeFee + fare;
            var commission = ((projectFee+overtimeFee) * 0.35-deposit-fare*0.5).toFixed(2);
            
            document.getElementById('commission').value = commission;
        }

        // 监听输入变化
        document.getElementById('deposit').addEventListener('input', calculateSalary);
        document.getElementById('project_fee').addEventListener('input', calculateSalary);
        document.getElementById('overtime_fee').addEventListener('input', calculateSalary);
        document.getElementById('fare').addEventListener('input', calculateSalary);

        // 提交表单
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            var formData = new FormData(this);
            
            fetch('user_update_record.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                var messageDiv = document.getElementById('message');
                if (data.success) {
                    messageDiv.className = 'message success show';
                    messageDiv.textContent = data.message || '保存成功！';
                    setTimeout(function() {
                        window.location.href = 'user_dashboard.html';
                    }, 1500);
                } else {
                    messageDiv.className = 'message error show';
                    messageDiv.textContent = data.message || '保存失败，请重试！';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                var messageDiv = document.getElementById('message');
                messageDiv.className = 'message error show';
                messageDiv.textContent = '保存失败：' + error.message;
            });
        });
    </script>
</body>
</html>
