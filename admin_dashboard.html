<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åå° - è´¹ç”¨ç»Ÿè®¡ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <div>
                <a href="admin_dashboard.html">æ•°æ®ç®¡ç†</a>
                <a href="admin_users.html">ä¸šåŠ¡å‘˜ç®¡ç†</a>
                <a href="admin_customers.html">ç”¨æˆ·ç®¡ç†</a>
                <a href="admin_accounts.html">æ”¶æ¬¾è´¦å·</a>
                <a href="admin_expenses.html">è®°äº‹æœ¬</a>
                <a href="admin_password.html">ä¿®æ”¹å¯†ç </a>
            </div>
            <div class="nav-right">
                <span id="adminName" style="color: white;"></span>
                <a href="admin_logout.php">é€€å‡ºç™»å½•</a>
            </div>
        </div>

        <h2>æ•°æ®è®°å½•ç®¡ç†</h2>
        <div id="message" class="message"></div>

        <div class="action-buttons">
            <button class="btn btn-danger" onclick="batchDelete()">æ‰¹é‡åˆ é™¤</button>
            <button class="btn btn-success" onclick="batchMarkPaid()">æ‰¹é‡æ ‡è®°å·²å‘</button>
            <button class="btn btn-warning" onclick="batchMarkUnpaid()">æ‰¹é‡æ ‡è®°æœªå‘</button>
            <select id="filterPaid" onchange="loadRecords()" style="width: auto;">
                <option value="">å…¨éƒ¨</option>
                <option value="1">å·²å‘æ”¾</option>
                <option value="0">æœªå‘æ”¾</option>
            </select>
            <input type="text" id="searchName" placeholder="è¾“å…¥ç”¨æˆ·å§“åæœç´¢" style="width: 180px; padding: 10px; margin-left: 10px;">
            <button class="btn btn-primary" onclick="loadRecords()" style="padding: 10px 20px;">æœç´¢</button>
            <button class="btn btn-warning" onclick="clearSearch()" style="padding: 10px 20px;">æ¸…é™¤</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                    <th>ID</th>
                    <th>ä¸šåŠ¡å‘˜</th>
                    <th>ç”¨æˆ·å§“å</th>
                    <th>æ—¥æœŸ</th>
                    <th>å®šé‡‘</th>
                    <th>åœ°å€</th>
                    <th>è½¦è´¹</th>
                    <th>é¡¹ç›®è´¹ç”¨</th>
                    <th>åŠ é’Ÿè´¹</th>
                    <th>åº”å¾—ä½£é‡‘35%</th>
                    <th>æ˜¯å¦å‘æ”¾</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="recordsTable">
            </tbody>
            <tfoot>
                <tr style="background-color: #f8f9fa; font-weight: bold;">
                    <td colspan="5" style="text-align: right; padding-right: 10px;">åˆè®¡ï¼š</td>
                    <td id="totalDeposit">0.00</td>
                    <td></td>
                    <td id="totalFare">0.00</td>
                    <td id="totalProjectFee">0.00</td>
                    <td id="totalOvertimeFee">0.00</td>
                    <td id="totalCommission">0.00</td>
                    <td></td>
                    <td><button class="btn btn-primary" onclick="showCalculationDetail()" style="padding: 5px 15px;">ç»“ç®—</button></td>
                </tr>
            </tfoot>
        </table>

        <!-- è®¡ç®—è¿‡ç¨‹å¼¹çª— -->
        <div id="calculationModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <span class="close" onclick="closeCalculationModal()">&times;</span>
                <h2>ä½£é‡‘ç»“ç®—è¯´æ˜</h2>
                
                <!-- å½“å‰åˆè®¡æ•°æ®è®¡ç®— -->
                <div style="padding: 20px; background-color: #d4edda; border-radius: 5px; margin: 20px 0; border: 2px solid #28a745;">
                    <h3 style="color: #155724; margin-bottom: 15px;">ğŸ“Š å½“å‰åˆè®¡æ•°æ®è®¡ç®—ï¼š</h3>
                    <div id="currentCalculation" style="background-color: white; padding: 15px; border-radius: 5px; line-height: 2.2;">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </div>
                </div>

                <div style="padding: 20px; background-color: #f8f9fa; border-radius: 5px; margin: 20px 0;">
                    <h3 style="color: #d9534f; margin-bottom: 15px;">ğŸ“ è®¡ç®—å…¬å¼ï¼š</h3>
                    <p style="font-size: 16px; line-height: 2; padding: 10px; background-color: white; border-left: 4px solid #d9534f;">
                        <strong>åº”å¾—ä½£é‡‘35%</strong> = (é¡¹ç›®è´¹ç”¨ + åŠ é’Ÿè´¹) Ã— 0.35 - è½¦è´¹ Ã· 2 - å®šé‡‘
                    </p>
                </div>
                
                <div style="padding: 20px; background-color: #e8f4f8; border-radius: 5px;">
                    <h3 style="color: #5bc0de; margin-bottom: 15px;">ğŸ“ è®¡ç®—æ­¥éª¤ï¼š</h3>
                    <ol style="line-height: 2; padding-left: 25px;">
                        <li><strong>ç¬¬ä¸€æ­¥ï¼š</strong>è®¡ç®—é¡¹ç›®æ€»é¢ = é¡¹ç›®è´¹ç”¨ + åŠ é’Ÿè´¹</li>
                        <li><strong>ç¬¬äºŒæ­¥ï¼š</strong>è®¡ç®—35%åŸºç¡€ä½£é‡‘ = é¡¹ç›®æ€»é¢ Ã— 0.35</li>
                        <li><strong>ç¬¬ä¸‰æ­¥ï¼š</strong>æ‰£é™¤è½¦è´¹çš„ä¸€åŠ = 35%åŸºç¡€ä½£é‡‘ - è½¦è´¹ Ã· 2</li>
                        <li><strong>ç¬¬å››æ­¥ï¼š</strong>æ‰£é™¤å®šé‡‘ = ä¸Šä¸€æ­¥ç»“æœ - å®šé‡‘</li>
                        <li><strong>æœ€ç»ˆç»“æœï¼š</strong>å¾—åˆ°åº”å¾—ä½£é‡‘35%</li>
                    </ol>
                </div>

                <div style="padding: 15px; background-color: #fcf8e3; border-radius: 5px; margin-top: 20px;">
                    <p style="margin: 0; color: #8a6d3b;"><strong>ğŸ’¡ æç¤ºï¼š</strong>ç³»ç»Ÿä¼šæ ¹æ®æ­¤å…¬å¼è‡ªåŠ¨è®¡ç®—æ¯æ¡è®°å½•çš„åº”å¾—ä½£é‡‘ã€‚</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åŠ è½½ç®¡ç†å‘˜ä¿¡æ¯
        fetch('admin_check_session.php')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    window.location.href = 'admin_login.html';
                } else {
                    document.getElementById('adminName').textContent = 'ç®¡ç†å‘˜: ' + data.data.username;
                }
            });

        // åŠ è½½è®°å½•
        function loadRecords() {
            var filterPaid = document.getElementById('filterPaid').value;
            var searchName = document.getElementById('searchName').value.trim();
            
            var url = 'admin_get_records.php?filter_paid=' + filterPaid;
            if (searchName) {
                url += '&search_name=' + encodeURIComponent(searchName);
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        var tbody = document.getElementById('recordsTable');
                        tbody.innerHTML = '';
                        
                        // åˆå§‹åŒ–åˆè®¡
                        var totalDeposit = 0;
                        var totalFare = 0;
                        var totalProjectFee = 0;
                        var totalOvertimeFee = 0;
                        var totalCommission = 0;
                        
                        data.records.forEach(function(record) {
                            var tr = document.createElement('tr');
                            tr.innerHTML = 
                                '<td><input type="checkbox" class="record-checkbox" value="' + record.id + '"></td>' +
                                '<td>' + record.id + '</td>' +
                                '<td>' + record.salesperson_name + '</td>' +
                                '<td>' + record.realname + '</td>' +
                                '<td>' + record.record_date + '</td>' +
                                '<td>' + record.deposit + '</td>' +
                                '<td>' + record.location + '</td>' +
                                '<td>' + record.fare + '</td>' +
                                '<td>' + record.project_fee + '</td>' +
                                '<td>' + record.overtime_fee + '</td>' +
                                '<td>' + record.commission + '</td>' +
                                '<td>' + (record.is_paid == 1 ? '<span style="color:green;">å·²å‘</span>' : '<span style="color:red;">æœªå‘</span>') + '</td>' +
                                '<td>' +
                                    '<button class="btn btn-info" style="padding:5px 10px;margin-right:5px;" onclick="editRecord(' + record.id + ')">ç¼–è¾‘</button>' +
                                    '<button class="btn btn-danger" style="padding:5px 10px;" onclick="deleteRecord(' + record.id + ')">åˆ é™¤</button>' +
                                '</td>';
                            tbody.appendChild(tr);
                            
                            // ç´¯åŠ é‡‘é¢
                            totalDeposit += parseFloat(record.deposit) || 0;
                            totalFare += parseFloat(record.fare) || 0;
                            totalProjectFee += parseFloat(record.project_fee) || 0;
                            totalOvertimeFee += parseFloat(record.overtime_fee) || 0;
                            totalCommission += parseFloat(record.commission) || 0;
                        });
                        
                        // æ›´æ–°åˆè®¡è¡Œ
                        document.getElementById('totalDeposit').textContent = totalDeposit.toFixed(2);
                        document.getElementById('totalFare').textContent = totalFare.toFixed(2);
                        document.getElementById('totalProjectFee').textContent = totalProjectFee.toFixed(2);
                        document.getElementById('totalOvertimeFee').textContent = totalOvertimeFee.toFixed(2);
                        document.getElementById('totalCommission').textContent = totalCommission.toFixed(2);
                    }
                });
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            var selectAll = document.getElementById('selectAll');
            var checkboxes = document.getElementsByClassName('record-checkbox');
            for (var i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = selectAll.checked;
            }
        }

        // è·å–é€‰ä¸­çš„è®°å½•ID
        function getSelectedIds() {
            var checkboxes = document.getElementsByClassName('record-checkbox');
            var ids = [];
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    ids.push(checkboxes[i].value);
                }
            }
            return ids;
        }

        // æ‰¹é‡åˆ é™¤
        function batchDelete() {
            var ids = getSelectedIds();
            if (ids.length == 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ' + ids.length + ' æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            fetch('admin_batch_action.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=delete&ids=' + ids.join(',')
            })
            .then(response => response.json())
            .then(data => {
                showMessage(data.success, data.message);
                if (data.success) {
                    loadRecords();
                }
            });
        }

        // æ‰¹é‡æ ‡è®°å·²å‘
        function batchMarkPaid() {
            var ids = getSelectedIds();
            if (ids.length == 0) {
                alert('è¯·é€‰æ‹©è¦æ ‡è®°çš„è®°å½•');
                return;
            }
            
            fetch('admin_batch_action.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=mark_paid&ids=' + ids.join(',')
            })
            .then(response => response.json())
            .then(data => {
                showMessage(data.success, data.message);
                if (data.success) {
                    loadRecords();
                }
            });
        }

        // æ‰¹é‡æ ‡è®°æœªå‘
        function batchMarkUnpaid() {
            var ids = getSelectedIds();
            if (ids.length == 0) {
                alert('è¯·é€‰æ‹©è¦æ ‡è®°çš„è®°å½•');
                return;
            }
            
            fetch('admin_batch_action.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=mark_unpaid&ids=' + ids.join(',')
            })
            .then(response => response.json())
            .then(data => {
                showMessage(data.success, data.message);
                if (data.success) {
                    loadRecords();
                }
            });
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(id) {
            window.location.href = 'admin_edit_record.html?id=' + id;
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            fetch('admin_delete_record.php?id=' + id)
                .then(response => response.json())
                .then(data => {
                    showMessage(data.success, data.message);
                    if (data.success) {
                        loadRecords();
                    }
                });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(success, message) {
            var messageDiv = document.getElementById('message');
            messageDiv.className = 'message ' + (success ? 'success' : 'error') + ' show';
            messageDiv.textContent = message;
            setTimeout(function() {
                messageDiv.className = 'message';
            }, 3000);
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            document.getElementById('searchName').value = '';
            loadRecords();
        }

        // æ˜¾ç¤ºè®¡ç®—è¿‡ç¨‹å¼¹çª—
        function showCalculationDetail() {
            // è·å–å½“å‰åˆè®¡æ•°æ®
            var totalDeposit = parseFloat(document.getElementById('totalDeposit').textContent) || 0;
            var totalFare = parseFloat(document.getElementById('totalFare').textContent) || 0;
            var totalProjectFee = parseFloat(document.getElementById('totalProjectFee').textContent) || 0;
            var totalOvertimeFee = parseFloat(document.getElementById('totalOvertimeFee').textContent) || 0;
            var totalCommission = parseFloat(document.getElementById('totalCommission').textContent) || 0;
            
            // è®¡ç®—è¿‡ç¨‹
            var step1 = totalProjectFee + totalOvertimeFee; // é¡¹ç›®æ€»é¢
            var step2 = step1 * 0.35; // 35%åŸºç¡€ä½£é‡‘
            var step3 = step2 - (totalFare / 2); // æ‰£é™¤è½¦è´¹ä¸€åŠ
            var step4 = step3 - totalDeposit; // æ‰£é™¤å®šé‡‘
            
            // ç”Ÿæˆè®¡ç®—è¿‡ç¨‹HTML
            var calculationHTML = `
                <p style="margin: 10px 0;"><strong>å·²æœ‰æ•°æ®ï¼š</strong></p>
                <p style="margin: 5px 0; padding-left: 20px;">â€¢ å®šé‡‘åˆè®¡ï¼š<span style="color: #007bff; font-weight: bold;">Â¥${totalDeposit.toFixed(2)}</span></p>
                <p style="margin: 5px 0; padding-left: 20px;">â€¢ è½¦è´¹åˆè®¡ï¼š<span style="color: #007bff; font-weight: bold;">Â¥${totalFare.toFixed(2)}</span></p>
                <p style="margin: 5px 0; padding-left: 20px;">â€¢ é¡¹ç›®è´¹ç”¨åˆè®¡ï¼š<span style="color: #007bff; font-weight: bold;">Â¥${totalProjectFee.toFixed(2)}</span></p>
                <p style="margin: 5px 0; padding-left: 20px;">â€¢ åŠ é’Ÿè´¹åˆè®¡ï¼š<span style="color: #007bff; font-weight: bold;">Â¥${totalOvertimeFee.toFixed(2)}</span></p>
                <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">
                <p style="margin: 10px 0;"><strong>è®¡ç®—è¿‡ç¨‹ï¼š</strong></p>
                <p style="margin: 5px 0; padding-left: 20px;"><strong style="color: #28a745;">â‘  é¡¹ç›®æ€»é¢</strong> = ${totalProjectFee.toFixed(2)} + ${totalOvertimeFee.toFixed(2)} = <strong>Â¥${step1.toFixed(2)}</strong></p>
                <p style="margin: 5px 0; padding-left: 20px;"><strong style="color: #28a745;">â‘¡ 35%åŸºç¡€ä½£é‡‘</strong> = ${step1.toFixed(2)} Ã— 0.35 = <strong>Â¥${step2.toFixed(2)}</strong></p>
                <p style="margin: 5px 0; padding-left: 20px;"><strong style="color: #28a745;">â‘¢ æ‰£é™¤è½¦è´¹ä¸€åŠ</strong> = ${step2.toFixed(2)} - (${totalFare.toFixed(2)} Ã· 2) = <strong>Â¥${step3.toFixed(2)}</strong></p>
                <p style="margin: 5px 0; padding-left: 20px;"><strong style="color: #28a745;">â‘£ æ‰£é™¤å®šé‡‘</strong> = ${step3.toFixed(2)} - ${totalDeposit.toFixed(2)} = <strong>Â¥${step4.toFixed(2)}</strong></p>
                <hr style="margin: 15px 0; border: 0; border-top: 2px solid #28a745;">
                <p style="margin: 10px 0; font-size: 18px; text-align: center;"><strong style="color: #d9534f;">æœ€ç»ˆåº”å¾—ä½£é‡‘35%ï¼šÂ¥${totalCommission.toFixed(2)}</strong></p>
            `;
            
            // å¡«å……åˆ°å¼¹çª—
            document.getElementById('currentCalculation').innerHTML = calculationHTML;
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('calculationModal').style.display = 'block';
        }

        // å…³é—­è®¡ç®—è¿‡ç¨‹å¼¹çª—
        function closeCalculationModal() {
            document.getElementById('calculationModal').style.display = 'none';
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
            var modal = document.getElementById('calculationModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });

        // å›è½¦é”®æœç´¢
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadRecords();
                }
            });
        });

        // é¡µé¢åŠ è½½æ—¶è·å–è®°å½•
        loadRecords();
    </script>
</body>
</html>

